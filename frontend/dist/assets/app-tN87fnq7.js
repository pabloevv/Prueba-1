let w=[],N={};function et(e){if(!e||!e.id)return null;const t=e.coords&&typeof e.coords.lat=="number"&&typeof e.coords.lng=="number";return{id:e.id,name:e.name||"Lugar",address:e.address||"",coords:t?{lat:e.coords.lat,lng:e.coords.lng}:null,photo:e.photo||""}}function vt(e){const t=Array.isArray(e)?e:[];w=[],N={},t.forEach(o=>{const n=et(o);n&&(w.push(n),N[n.id]=n)})}function St(e){const t=et(e);if(!t)return;const o=w.findIndex(n=>n.id===t.id);o>=0?(w[o]={...w[o],...t},N[t.id]=w[o]):(w.push(t),N[t.id]=t)}let O=[],Ee=!1;function tt(e,t){if(!e)return null;const o=t||Z(),n=e.placeId?N[e.placeId]:null,s=e.coords&&typeof e.coords.lat=="number"&&typeof e.coords.lng=="number"?{lat:e.coords.lat,lng:e.coords.lng}:n?.coords||null,i=typeof e.createdAt=="number"?e.createdAt:Date.parse(e.createdAt)||Date.now(),l=e.userUid||e.uid||null,c=!!(o&&(l&&o.uid===l||e.userId&&o.id&&String(o.id)===String(e.userId))),d=e.userName&&String(e.userName).trim()?String(e.userName).trim():c?o?.displayName||o?.email||"Yo":"Visitante",b=Array.isArray(e.images)?e.images.map(E=>E&&E.url?{...E}:null).filter(Boolean):[],f=n?.photo||"",x=e.photo||(b.length?b[0].url:"")||f;return{id:e.id,placeId:e.placeId,city:e.city||n?.address||"",rating:Number(e.rating)||0,photo:x,note:e.note||"",tags:Array.isArray(e.tags)?e.tags.map(E=>String(E).trim()).filter(Boolean):[],userId:e.userId??null,userUid:l,userName:d,me:c,up:Number(e.up)||0,down:Number(e.down)||0,createdAt:i,coords:s,myVote:Number(e.myVote||0),images:b}}function Lt(e,t){O=(Array.isArray(e)?e:[]).map(n=>tt(n,t)).filter(Boolean)}function G(){const e=Z();O.forEach(t=>{const o=!!(e&&(t.userUid&&t.userUid===e.uid||t.userId&&e.id&&String(t.userId)===String(e.id)));t.me=o,o&&(t.userName=e.displayName||e.email||e.username||t.userName)})}async function Et(e=!1){if(!m||!m.currentUser)return null;if(!e&&H)return H;if(!e&&te)return te;const t=m.currentUser.getIdToken(e);te=t;try{const o=await t;return H=o,o}catch(o){return console.error("No se pudo obtener el ID token de Firebase:",o),null}finally{te=null}}async function V(e,t={},{auth:o=!0}={}){const n={...t},a=n.headers instanceof Headers?new Headers(n.headers):new Headers(n.headers||{});n.body&&!(n.body instanceof FormData)&&!a.has("Content-Type")&&a.set("Content-Type","application/json"),a.set("Accept","application/json");async function s(c=!1){const d=new Headers(a);if(o){const f=await Et(c);f?d.set("Authorization",`Bearer ${f}`):d.delete("Authorization")}return await fetch(e,{...n,headers:d})}let i=await s(!1);o&&i.status===401&&m?.currentUser&&(H=null,i=await s(!0));let l=null;try{const c=await i.text();l=c?JSON.parse(c):null}catch(c){console.warn("No se pudo interpretar la respuesta JSON de",e,c)}return{response:i,payload:l}}async function ot(e=!1){if(!(Ee&&!e))try{const[t,o]=await Promise.all([V(`${R}/places`),V(`${R}/reviews`)]);if(!t.response?.ok)throw new Error(t.payload?.error||"No se pudieron cargar los lugares.");if(!o.response?.ok)throw new Error(o.payload?.error||"No se pudieron cargar las reseñas.");vt(t.payload?.places);const n=Z();Lt(o.payload?.reviews,n),G(),_(),z(),Ee=!0}catch(t){console.error("Error al cargar datos iniciales",t)}}const D=new Map;function _(){D.clear(),O.forEach(e=>{const t=e.userUid||e.userId;if(!t)return;const o=(D.get(t)||0)+(e.up-e.down);D.set(t,o)})}function xe(e){return e>=10?{label:"Experto",color:"#fbbf24"}:e>=3?{label:"Confiable",color:"#34d399"}:{label:"Novato",color:"#94a3b8"}}const Nt=document.querySelectorAll(".screen"),He=document.querySelectorAll(".tabs button"),Ge=document.getElementById("feedList"),Ve=document.getElementById("profileList"),nt=document.getElementById("searchInput"),ie=document.getElementById("profileStats"),ye=document.getElementById("profileName"),be=document.getElementById("profileHandle"),qe=document.getElementById("map"),Re=document.getElementById("mapSearchForm"),le=document.getElementById("mapSearchInput"),Ie=document.getElementById("mapSearchStatus"),ce=document.getElementById("mapSearchSuggestions"),Pt=document.getElementById("addPlaceSearchForm"),de=document.getElementById("addPlaceSearchInput"),K=document.getElementById("addPlaceSuggestions"),We=document.getElementById("addPlaceStatus"),Ye=document.getElementById("addPlaceMap"),k=document.getElementById("f_placeName"),q=document.getElementById("f_placeAddress"),Ne=document.getElementById("f_rating"),u=document.getElementById("f_photo"),Pe=document.getElementById("f_note"),$e=document.getElementById("f_tags"),T=document.getElementById("f_photo_file"),ve=document.getElementById("photoPreview"),ue=document.getElementById("loginOverlay"),pe=document.getElementById("loginForm"),je=document.getElementById("loginStatus"),we=document.getElementById("loginEmail"),J=document.getElementById("loginPassword"),Be=document.getElementById("loginGoogle"),Me="luggo:auth:v2",R=window.__API_BASE_URL__||"/api",$t=720;function wt(e){if(!e||typeof e!="string")return e;const t=e.trim();return t&&(t.endsWith(".firebaseapp.com")?t.replace(/\.firebaseapp\.com$/,".firebasestorage.app"):(t.endsWith(".firebasestorage.app"),t))}const Y=(()=>{if(!window.__FIREBASE_CONFIG__)return null;const e={...window.__FIREBASE_CONFIG__},t=wt(e.storageBucket);return t&&t!==e.storageBucket&&(e.storageBucket=t,window.__FIREBASE_CONFIG__.storageBucket=t),e})(),Bt="luggo";let m=null,X=null,ee=!1,H=null,te=null;function Mt(e){return new Promise((t,o)=>{const n=new FileReader;n.onload=()=>t(n.result),n.onerror=()=>o(n.error||new Error("No se pudo leer el archivo.")),n.readAsDataURL(e)})}function At(e,t=$t){return!e||typeof e!="string"||!e.startsWith("data:image/")?Promise.resolve(e):new Promise((o,n)=>{const a=new Image;a.onload=()=>{const{width:s,height:i}=a;if(!s||!i){o(e);return}const l=Math.max(s,i);if(l<=t){o(e);return}const c=t/l,d=Math.round(s*c),b=Math.round(i*c),f=document.createElement("canvas");f.width=d,f.height=b,f.getContext("2d",{willReadFrequently:!1}).drawImage(a,0,0,d,b);try{const E=f.toDataURL("image/jpeg",.82);o(E)}catch(E){n(E)}},a.onerror=()=>n(new Error("No se pudo procesar la imagen seleccionada.")),a.src=e})}async function Ct(e){return(await fetch(e)).blob()}function Ft(e){return new Promise((t,o)=>{const n=new Image;n.onload=()=>{t({width:n.width,height:n.height})},n.onerror=()=>o(new Error("No se pudieron obtener las dimensiones de la imagen.")),n.src=e})}async function kt(e){if(!e||typeof e!="string")return null;const t=e.trim();if(!t)return null;try{return await At(t)}catch(o){return console.warn("No se pudo optimizar la imagen en el cliente:",o),t}}function g(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function B(e){return g(e)}function xt(e){const t=Math.floor((Date.now()-e)/1e3);if(t<60)return"hace un momento";const o=Math.floor(t/60);if(o<60)return`hace ${o} min`;const n=Math.floor(o/60);return n<24?`hace ${n} h`:`hace ${Math.floor(n/24)} d`}function Tt(e){return"★".repeat(e)+"☆".repeat(5-e)}function fe(e){return`https://source.unsplash.com/600x400/?${encodeURIComponent(e)}`}function _t(e){const o=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 360"><rect fill="#1f2937" width="640" height="360"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="Segoe UI, Roboto, sans-serif" font-size="36" fill="#e5e7eb">${g(e)}</text></svg>`;return`data:image/svg+xml,${encodeURIComponent(o)}`}function at(e){return e.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"").slice(0,48)||"lugar"}function zt(e){const t=at(e||`lugar-${Date.now()}`);if(!N[t])return t;let o=1;for(;N[`${t}-${o}`];)o+=1;return`${t}-${o}`}function rt(e){return N[e]?.name||"Lugar"}function st(e){return N[e]?.address||""}function Ot(e){const t=N[e];return t?(t.photo||(t.photo=fe(t.name||t.address||t.id)),t.photo):""}function Ut(e,t,o,n){const a=d=>d*Math.PI/180,s=a(o-e),i=a(n-t),l=Math.sin(s/2)**2+Math.cos(a(e))*Math.cos(a(o))*Math.sin(i/2)**2;return 6371*(2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l)))}function Dt(e){return Number.isFinite(e)?e<1?`${Math.round(e*1e3)} m`:`${e.toFixed(1)} km`:""}function it(e,t=250){let o=null;return(...n)=>{clearTimeout(o),o=setTimeout(()=>e(...n),t)}}function W(e,t="Vista previa"){ve&&(e?ve.innerHTML=`<img src="${B(e)}" alt="${B(t)}" />`:ve.innerHTML='<div class="placeholder">Selecciona un lugar o carga una imagen para ver la vista previa.</div>')}W(null);function Z(){const e=localStorage.getItem(Me);if(!e)return null;try{return JSON.parse(e)}catch{return null}}function Te(e){if(e){const t={uid:e.uid,id:e.id??null,displayName:e.displayName||"",email:e.email||"",photoURL:e.photoURL||null,role:e.role||"usr",stats:e.stats||{reviews:0}};localStorage.setItem(Me,JSON.stringify(t)),Ae(t)}else localStorage.removeItem(Me),Ae(null)}function M(e){je&&(je.textContent=e||"")}function me(e){pe&&pe.classList.toggle("pending",e),[we,J,Be].forEach(t=>{t&&(t.disabled=e)})}function lt(){ue&&ue.classList.add("hidden")}function Q(){ue&&ue.classList.remove("hidden")}function Ae(e){if(!ye||!be)return;if(!e){ye.textContent="Visitante",be.textContent="";return}ye.textContent=e.displayName||e.email||"Visitante";const t=e.email?e.email:e.uid?`@${String(e.uid).slice(0,8)}`:"";if(be.textContent=t,ie&&e.stats?.reviews!==void 0){const o=e.uid||e.id,n=o&&D.get(o)||0,a=xe(n);ie.textContent=`${e.stats.reviews} reseñas - Rango: ${a.label} (${n})`}}function Ce(e){switch(e?.code||""){case"auth/wrong-password":return"Contraseña incorrecta.";case"auth/user-not-found":return"No encontramos tu cuenta. La crearemos si completas los datos.";case"auth/invalid-email":return"El correo no es válido.";case"auth/email-already-in-use":return"Ya existe una cuenta con este correo.";case"auth/weak-password":return"La contraseña debe tener al menos 6 caracteres.";case"auth/popup-closed-by-user":return"Cierra la ventana solo después de completar el inicio de sesión.";default:return e?.message||"No se pudo iniciar sesión."}}async function Ht(){try{const{response:e,payload:t}=await V(`${R}/auth/session`,{method:"POST"});e.ok&&t?.user&&(Te(t.user),G(),_(),z())}catch(e){console.error("No se pudo sincronizar la sesión con el backend:",e)}}async function Gt(e){if(e.preventDefault(),!m){M("Firebase no está configurado.");return}if(!we||!J)return;const t=we.value.trim().toLowerCase(),o=J.value;if(!t||!o){M("Completa correo y contraseña.");return}me(!0),M("");try{await m.signInWithEmailAndPassword(t,o),J.value=""}catch(n){if(n?.code==="auth/user-not-found")try{await m.createUserWithEmailAndPassword(t,o),J.value=""}catch(a){console.error("No se pudo crear la cuenta con correo:",a),M(Ce(a))}else console.error("Error al iniciar sesión con correo:",n),M(Ce(n))}finally{me(!1)}}async function Vt(){if(!m||typeof firebase>"u"||!firebase.auth){M("Firebase no está configurado.");return}me(!0),M("");const e=new firebase.auth.GoogleAuthProvider;try{await m.signInWithPopup(e)}catch(t){console.error("No se pudo iniciar sesión con Google:",t),M(Ce(t))}finally{me(!1)}}async function qt(){try{m&&await m.signOut()}catch(e){console.error("No se pudo cerrar sesión:",e)}finally{H=null,Te(null),Q(),G(),_(),z()}}window.logout=qt;async function Rt(){if(ee)return;if(!Y){console.warn("No se definió window.__FIREBASE_CONFIG__."),ee=!0;return}if(typeof firebase>"u"){console.warn("Firebase SDK no está disponible."),ee=!0;return}firebase.initializeApp(Y),m=firebase.auth();const e=typeof Y.storageBucket=="string"&&Y.storageBucket.trim()?Y.storageBucket.trim():null;if(e)try{X=firebase.app().storage(`gs://${e}`)}catch(t){console.warn("No se pudo inicializar Firebase Storage con el bucket especificado:",t),X=firebase.storage()}else X=firebase.storage();m.onIdTokenChanged(()=>{H=null}),m.onAuthStateChanged(async t=>{if(ee=!0,!t){Te(null),Q(),G(),_(),z();return}lt(),await Ht(),Ee?(G(),_(),z()):await ot(!0).catch(()=>{})})}function Wt(){pe&&pe.addEventListener("submit",Gt),Be&&Be.addEventListener("click",Vt);const e=Z();e?(Ae(e),lt()):Q(),Rt().catch(t=>{console.error("No se pudo inicializar Firebase:",t),M("Revisa la configuración de Firebase.")})}const j=new Set;async function Yt(e,t){const o=String(e);if(j.has(o))return;const n=O.find(i=>String(i.id)===o);if(!n)return;if(!m?.currentUser){Q();return}const a=Number(n.myVote||0);let s=t;a===t&&(s=0),j.add(o);try{const{response:i,payload:l}=await V(`${R}/reviews/${e}/vote`,{method:"POST",body:JSON.stringify({value:s})});if(!i.ok){j.delete(o),console.error("No se pudo registrar el voto",l?.error);return}n.up=Number(l?.up)||n.up,n.down=Number(l?.down)||n.down,n.myVote=s,_(),z(),j.delete(o)}catch(i){j.delete(o),console.error("Error al registrar voto",i)}}window.vote=Yt;function ct(e){const t=(nt?.value||"").toLowerCase().trim();return t?e.filter(o=>[rt(o.placeId),st(o.placeId),o.city,o.note,...o.tags].join(" ").toLowerCase().includes(t)):e}function dt(e){const t=rt(e.placeId),o=e.tags.map(E=>`<span class="tag">#${g(E)}</span>`).join(" "),n=e.photo||Ot(e.placeId),a=_t(t),i=B(n||a),l=B(t),c=B(a),d=D.get(e.userUid||e.userId)||0,b=xe(d),f=e.myVote===1?"active":"",x=e.myVote===-1?"active":"";return`
    <article class="card">
      <div class="media">
        <img src="${i}" alt="${l}" loading="lazy" referrerpolicy="no-referrer" onerror="this.onerror=null;this.src='${c}'" />
      </div>
      <div class="content">
        <div class="row">
          <div>
            <div class="title">${g(t)}</div>
            <div class="muted">${g(e.city||st(e.placeId))}</div>
          </div>
          <div style="text-align:right">
            <div class="chip" title="Autor">${e.me?"Tú":g(e.userName)}</div>
            <div class="rank" style="margin-top:.3rem;border-color:${b.color};color:${b.color}" title="Rango por confiabilidad">${b.label}</div>
          </div>
        </div>
        <div class="sp-1"></div>
        <div class="row">
          <div class="meta"><span class="stars">${Tt(e.rating)}</span><span>${e.rating}.0</span></div>
          <div class="muted">${xt(e.createdAt)}</div>
        </div>
        <div class="sp-1"></div>
        <div>${g(e.note)}</div>
        <div class="sp-1"></div>
        <div class="row">
          <div>${o}</div>
          <div class="vote">
            <button class="${f}" data-vote="up" onclick="vote('${B(String(e.id))}', 1)" aria-pressed="${e.myVote===1}" aria-label="Me gusta">
              <span class="icon">👍</span>
              <span class="count">${e.up}</span>
            </button>
            <button class="${x}" data-vote="down" onclick="vote('${B(String(e.id))}', -1)" aria-pressed="${e.myVote===-1}" aria-label="No me gusta">
              <span class="icon">👎</span>
              <span class="count">${e.down}</span>
            </button>
          </div>
        </div>
      </div>
    </article>`}function _e(){const e=ct([...O]).sort((t,o)=>o.createdAt-t.createdAt);Ge&&(Ge.innerHTML=e.map(dt).join(""))}function ze(){const e=ct(O.filter(a=>a.me)).sort((a,s)=>s.createdAt-a.createdAt);Ve&&(Ve.innerHTML=e.map(dt).join(""));const t=e[0]?.userUid||e[0]?.userId||"self",o=D.get(t)||0,n=xe(o);ie&&(ie.textContent=`${e.length} reseñas - Rango: ${n.label} (${o})`)}function z(){_e(),ze(),pt()}let S=null,re=null,se=null;function Fe(){S&&requestAnimationFrame(()=>S.invalidateSize())}function ut(){if(!(!qe||typeof L>"u")){if(S){Fe();return}S=L.map(qe,{zoomControl:!1}).setView([9.935,-84.09],13),L.control.zoom({position:"topright"}).addTo(S),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"© OpenStreetMap contributors"}).addTo(S),re=L.layerGroup().addTo(S),se=L.layerGroup().addTo(S),pt(),setTimeout(Fe,200)}}function pt(){!S||!re||(re.clearLayers(),w.filter(e=>e.coords).forEach(e=>{const t=L.marker([e.coords.lat,e.coords.lng]),o=`<strong>${g(e.name)}</strong><br>${g(e.address||"")}`;t.bindPopup(o),t.addTo(re)}))}let Se=null;function oe(e){Ie&&(Ie.textContent=e||"",Se&&clearTimeout(Se),e&&(Se=setTimeout(()=>{Ie.textContent=""},5e3)))}async function jt(e,t=5){const o=new URLSearchParams({q:e,format:"jsonv2",addressdetails:"1",dedupe:"1",limit:String(t)}),n=await fetch(`https://nominatim.openstreetmap.org/search?${o.toString()}`,{headers:{"Accept-Language":"es"},referrerPolicy:"no-referrer"});if(!n.ok)throw new Error("No se pudo buscar");return n.json()}async function Jt(e,t){const o=new URLSearchParams({lat:String(e),lon:String(t),format:"jsonv2",zoom:"16"}),n=await fetch(`https://nominatim.openstreetmap.org/reverse?${o.toString()}`,{headers:{"Accept-Language":"es"},referrerPolicy:"no-referrer"});return n.ok?n.json():null}let y=null;function Xt(){"geolocation"in navigator&&navigator.geolocation.getCurrentPosition(e=>{y={lat:e.coords.latitude,lng:e.coords.longitude},S&&S.flyTo([y.lat,y.lng],14,{duration:.8}),v&&v.setView([y.lat,y.lng],14)},e=>{console.warn("No se pudo obtener la ubicación del usuario",e)},{enableHighAccuracy:!0,maximumAge:6e4,timeout:7e3})}function mt(e,t){const o=parseFloat(e.lat),n=parseFloat(e.lon);if(!Number.isFinite(o)||!Number.isFinite(n))return null;const a=e.title||e.namedetails?.name||e.name||e.display_name?.split(",")[0]||t,s=e.subtitle||e.address?.city||e.address?.town||e.address?.village||e.address?.state||e.display_name||"",i=y?Ut(y.lat,y.lng,o,n):null;return{title:a,subtitle:s,displayName:e.display_name||`${a}${s?`, ${s}`:""}`,lat:o,lon:n,distance:i,photo:e.photo||fe(a||s||t)}}function Kt(e){const t=e.toLowerCase();return w.filter(o=>o.name.toLowerCase().startsWith(t)||o.address.toLowerCase().startsWith(t)).map(o=>mt({title:o.name,subtitle:o.address,display_name:`${o.name}, ${o.address}`,lat:o.coords?.lat,lon:o.coords?.lng,photo:o.photo},e)).filter(Boolean)}async function ge(e){const t=e.trim();if(t.length<2)return[];const o=t.toLowerCase(),n=Kt(t);let a=[];try{a=(await jt(t,8)).map(d=>mt(d,t)).filter(Boolean).filter(d=>d.title.toLowerCase().startsWith(o)||d.displayName.toLowerCase().startsWith(o))}catch(c){console.error("Error buscando sugerencias remotas",c)}const s=[...n,...a],i=[],l=new Set;return s.forEach(c=>{const d=`${c.title.toLowerCase()}|${c.lat?.toFixed(4)||""}|${c.lon?.toFixed(4)||""}`;l.has(d)||(l.add(d),i.push(c))}),i.sort((c,d)=>y&&c.distance!=null&&d.distance!=null?c.distance-d.distance:c.title.localeCompare(d.title,"es")),i.slice(0,5)}function C(e,t,o){e&&(e.innerHTML="",t.length&&t.forEach(n=>{const a=document.createElement("button");a.type="button",a.className="map-suggestion-item";const s=n.distance!=null?Dt(n.distance):"";a.innerHTML=`
      <div>
        <strong>${g(n.title)}</strong><br>
        <span>${g(n.subtitle||"")}</span>
      </div>
      ${s?`<span>${g(s)}</span>`:""}
    `,a.addEventListener("click",()=>o(n)),e.appendChild(a)}))}function ft(e,t,o,n){if(ut(),se){se.clearLayers();const a=L.marker([e,t]);a.bindPopup(`
      <strong>${g(o)}</strong><br>
      <img src="${B(n)}" alt="${B(o)}" style="margin-top:8px;border-radius:12px;max-width:220px;height:auto;" loading="lazy" referrerpolicy="no-referrer" />
    `),a.addTo(se).openPopup()}S?.flyTo([e,t],15,{duration:.8})}const Zt=it(async e=>{const t=await ge(e);C(ce,t,o=>{le.value=o.title,C(ce,[],()=>{}),ft(o.lat,o.lon,o.displayName,o.photo)})},250),Qt=it(async e=>{const t=await ge(e);C(K,t,o=>{de.value=o.title,C(K,[],()=>{}),Oe(),A&&A.setLatLng([o.lat,o.lon]).bindPopup(g(o.displayName)).openPopup(),v?.flyTo([o.lat,o.lon],16,{duration:.6}),Ue({name:o.title,address:o.subtitle||o.displayName,coords:{lat:o.lat,lng:o.lon},photo:o.photo})})},250);function eo(){le?.addEventListener("input",()=>{const e=le.value.trim();if(e.length<2){C(ce,[],()=>{});return}Zt(e)}),de?.addEventListener("input",()=>{const e=de.value.trim();if(e.length<2){C(K,[],()=>{});return}Qt(e)})}function to(){Re&&Re.addEventListener("submit",async e=>{e.preventDefault();const t=le?.value.trim();if(t){oe("Buscando lugar...");try{const o=await ge(t);if(!o.length){oe("No se encontró ningún resultado.");return}const n=o[0];ft(n.lat,n.lon,n.displayName,n.photo),oe("Marcador agregado desde la búsqueda."),C(ce,[],()=>{})}catch(o){console.error("Error buscando lugar",o),oe("Error al buscar el lugar. Intenta nuevamente.")}}})}let v=null,A=null,r=null;function p(e){We&&(We.textContent=e||"")}function Oe(){if(!Ye||typeof L>"u")return;if(v){setTimeout(()=>v.invalidateSize(),200);return}const e=y?[y.lat,y.lng]:[9.935,-84.09];v=L.map(Ye,{zoomControl:!0,attributionControl:!1}).setView(e,13),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"© OpenStreetMap contributors"}).addTo(v),A=L.marker(e).addTo(v),A.bindPopup("Haz clic en el mapa o usa la búsqueda."),v.on("click",async t=>{const{lat:o,lng:n}=t.latlng;A.setLatLng(t.latlng);const a=await Jt(o,n),s=a?.name||a?.display_name?.split(",")[0]||k?.value||"Lugar sin nombre",i=a?.display_name||q?.value||"";Ue({name:s,address:i,coords:{lat:o,lng:n},photo:fe(s)}),A.bindPopup(g(s)).openPopup()}),setTimeout(()=>v.invalidateSize(),200)}function Ue({name:e,address:t,coords:o,photo:n}){const a=r||{},s=n??a.autoPhoto??null,i=a.manualPhoto||"",l=!!i;if(r={...a,name:e??a.name??"",address:t??a.address??"",coords:o??a.coords??null,autoPhoto:s,manualPhoto:i,photo:l?i:a.uploadBlob?a.photo:s||"",uploadBlob:l?null:a.uploadBlob??null,uploadMeta:l?null:a.uploadMeta??null,uploadFileName:l?null:a.uploadFileName??null},n!==void 0&&!l&&(r.photo=s||"",r.uploadBlob=null,r.uploadMeta=null,r.uploadFileName=null),k&&r.name&&(k.value=r.name),q&&r.address&&(q.value=r.address),u&&!l&&(r.photo?(u.value=r.photo,u.dataset.auto="true"):(u.value="",u.dataset.auto="false")),(!l||!r.photo)&&W(r.photo,r.name||"Vista previa"),r.coords){const{lat:c,lng:d}=r.coords;p(`Lugar seleccionado: ${c.toFixed(5)}, ${d.toFixed(5)}`)}}u&&(u.dataset.manual="false",u.dataset.auto="false",u.addEventListener("input",()=>{const e=u.value.trim();r||(r={}),e?(r.manualPhoto=e,r.photo=e,r.uploadBlob=null,r.uploadMeta=null,r.uploadFileName=null,u.dataset.manual="true",u.dataset.auto="false",T&&(T.value=""),W(e,k?.value||"Imagen personalizada")):(r.manualPhoto="",r.photo=r.autoPhoto||"",u.dataset.manual="false",u.dataset.auto=r.photo?"true":"false",W(r.photo,r.name||"Vista previa"))}));T&&T.addEventListener("change",async()=>{const e=T.files?.[0];if(e){p("Procesando imagen (máx 720p)...");try{const t=await Mt(e),o=await kt(t);r||(r={});const n=await Ct(o),a=await Ft(o);r.manualPhoto="",r.autoPhoto=r.autoPhoto||r.photo||"",r.photo=o,r.uploadBlob=n,r.uploadMeta={width:a.width,height:a.height,size:n.size,contentType:n.type||"image/webp"},r.uploadFileName=`foto-${Date.now()}.webp`,u.value="",u.dataset.manual="false",u.dataset.auto="false",W(o,e.name||k?.value||"Imagen local"),p("Imagen optimizada lista para subir.")}catch(t){console.error("Error al procesar la imagen local:",t),p("No se pudo procesar la imagen. Intenta con otro archivo.")}}});Pt?.addEventListener("submit",async e=>{e.preventDefault();const t=de?.value.trim();if(t){p("Buscando en el mapa...");try{const o=await ge(t);if(!o.length){p("No se encontró ningún resultado.");return}const n=o[0];Oe(),A?.setLatLng([n.lat,n.lon]).bindPopup(g(n.displayName)).openPopup(),v?.flyTo([n.lat,n.lon],16,{duration:.6}),Ue({name:n.title,address:n.subtitle||n.displayName,coords:{lat:n.lat,lng:n.lon},photo:n.photo}),C(K,[],()=>{})}catch(o){console.error("Error en búsqueda del modal",o),p("Error al buscar. Intenta nuevamente.")}}});const gt=document.getElementById("modal");function oo(){k&&(k.value=""),q&&(q.value=""),Ne&&(Ne.value="5"),u&&(u.value="",u.dataset.manual="false",u.dataset.auto="false"),T&&(T.value=""),Pe&&(Pe.value=""),$e&&($e.value=""),r=null,C(K,[],()=>{});const e=y?[y.lat,y.lng]:[9.935,-84.09];p("Selecciona una ubicación en el mapa."),W(null),A&&v&&(A.setLatLng(e).bindPopup("Haz clic en el mapa o usa la búsqueda."),v.setView(e,13))}function no(){gt?.classList.add("show"),Oe(),oo(),setTimeout(()=>v?.invalidateSize(),250)}function ht(){gt?.classList.remove("show")}window.openCreateModal=no;window.closeCreateModal=ht;async function ao(){const e=(k?.value||"").trim(),t=(q?.value||"").trim(),o=Number(Ne?.value||5),n=(u?.value||"").trim(),a=(Pe?.value||"").trim(),s=($e?.value||"").split(",").map(I=>I.trim()).filter(Boolean);if(!r?.coords){alert("Selecciona un punto en el mapa.");return}if(!e){alert("Ingresa el nombre del lugar.");return}const i=Z();if(!i){p("Inicia sesion para publicar tu reseña."),Q();return}if(!m?.currentUser||!X){p("Firebase no está configurado correctamente.");return}const l=at(e),c=N[l]?zt(e):l,d=u?.dataset.manual==="true"&&n,b=r.photo||r.autoPhoto||fe(e||t);let f=d?n:b||"";const x=[];if(r.uploadBlob){p("Subiendo imagen a Firebase...");try{const I=m.currentUser.uid,P=(r.uploadMeta?.contentType||"image/webp").includes("png")?"png":"webp",$=`${Date.now()}-${Math.random().toString(36).slice(2)}.${P}`,De=X.ref().child(`${Bt}/${I}/${$}`);await De.put(r.uploadBlob,{contentType:r.uploadMeta?.contentType||"image/webp",cacheControl:"public,max-age=31536000"}),f=await De.getDownloadURL(),p("Guardando metadatos de la imagen...");const{response:It,payload:he}=await V(`${R}/images`,{method:"POST",body:JSON.stringify({u:f,w:r.uploadMeta?.width,h:r.uploadMeta?.height,s:r.uploadMeta?.size,pv:"fb"})});if(!It.ok){p(he?.error||"No se pudo guardar la imagen.");return}he?.image?.id&&x.push(he.image.id)}catch(I){console.error("No se pudo subir la imagen a Firebase:",I);const P=typeof I?.message=="string"&&I.message.trim()?I.message.trim():"Intenta nuevamente.",$=typeof I?.code=="string"?I.code:null;p($?`No se pudo subir la imagen (${$}). ${P}`:`No se pudo subir la imagen. ${P}`);return}}const E={id:c,name:e,address:t,coords:r.coords,photo:f||b||""};p("Guardando reseña...");try{const{response:I,payload:P}=await V(`${R}/reviews`,{method:"POST",body:JSON.stringify({place:E,rating:o,note:a,tags:s,city:t,imageIds:x,photo:f})});if(!I.ok){p(P?.error||"No se pudo guardar la reseña.");return}if(P?.place&&St(P.place),!P?.review){p("Respuesta inesperada del servidor.");return}const $=tt(P.review,i);O.push($),G(),_(),z(),p(""),r=null,ht(),S&&$?.coords&&S.flyTo([$.coords.lat,$.coords.lng],15,{duration:.8}),document.querySelector('[data-tab="feed"]')?.click()}catch(I){console.error("Error al crear la reseña",I),p("No se pudo guardar la reseña. Intenta nuevamente.")}}window.saveReview=ao;He.forEach(e=>e.addEventListener("click",()=>{const t=e.dataset.tab;He.forEach(o=>o.classList.toggle("active",o===e)),Nt.forEach(o=>o.classList.toggle("active",o.dataset.screen===t)),t==="feed"&&_e(),t==="profile"&&ze(),t==="map"&&(ut(),setTimeout(Fe,250))}));nt?.addEventListener("input",()=>{_e(),ze()});const h=document.querySelector(".fab"),F=h?.querySelector("button"),yt="luggo-fab-position",ro=12;let ne=!1,U=null,Je=0,Xe=0,Ke=0,Ze=0,ae=!1,Le=!1;function bt(e,t){const o=ro,n=Math.max(o,window.innerWidth-h.offsetWidth-o),a=Math.max(o,window.innerHeight-h.offsetHeight-o);return{left:Math.min(Math.max(o,e),n),top:Math.min(Math.max(o,t),a)}}function ke(e,t){const{left:o,top:n}=bt(e,t);return h.style.left=`${o}px`,h.style.top=`${n}px`,h.style.right="auto",h.style.bottom="auto",{left:o,top:n}}function so(){const e=localStorage.getItem(yt);if(e)try{const t=JSON.parse(e);typeof t.left=="number"&&typeof t.top=="number"&&ke(t.left,t.top)}catch(t){console.warn("No se pudo restaurar la posición del botón flotante",t)}}function Qe(){const e=h.getBoundingClientRect(),t=bt(e.left,e.top);localStorage.setItem(yt,JSON.stringify(t))}function io(){if(!h||!F)return;so(),F.addEventListener("pointerdown",t=>{U=t.pointerId,ne=!0,ae=!1,Ke=t.clientX,Ze=t.clientY;const o=h.getBoundingClientRect();Je=t.clientX-o.left,Xe=t.clientY-o.top,h.classList.add("dragging"),F.setPointerCapture(U)}),F.addEventListener("pointermove",t=>{if(!ne||t.pointerId!==U)return;const o=t.clientX-Ke,n=t.clientY-Ze;!ae&&Math.hypot(o,n)>5&&(ae=!0);const a=t.clientX-Je,s=t.clientY-Xe;ke(a,s)});const e=t=>{!ne||t.pointerId!==U||(ne=!1,h.classList.remove("dragging"),F.releasePointerCapture(U),U=null,ae&&(Le=!0,Qe()))};F.addEventListener("pointerup",e),F.addEventListener("pointercancel",e),F.addEventListener("click",t=>{Le&&(Le=!1,t.preventDefault(),t.stopPropagation())}),window.addEventListener("resize",()=>{if(!h.style.left||!h.style.top)return;const t=h.getBoundingClientRect();ke(t.left,t.top),Qe()})}async function lo(){Wt(),io(),to(),eo(),Xt(),await ot()}lo().then(()=>{typeof window<"u"&&(window.__LUGGO_LEGACY_INITIALIZED__=!0)}).catch(e=>{console.error("Error al iniciar la aplicacion",e)});
